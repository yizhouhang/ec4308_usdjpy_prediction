---
title: "4308_proj_taylor"
author: "Erica"
date: "2025-11-05"
output: html_document
---

```{r}
# ---- packages ----
library (readr)
library (dplyr)
library (lubridate)
library (stringr)
```

#### Inflation Rate
```{r}
# ---- helper: YoY log change from level CPI ---
yoy_log = function(x, lag_n = 12) {
  log(x) - dplyr::lag(log(x), lag_n)
}

# ---- US inflation rate ----
us_path = '../data/cpi_us_fred_md_raw.csv'
us_raw = read_csv(us_path, show_col_types = FALSE)
us_raw = us_raw %>% filter(date >= '1974-01-01')
us = us_raw %>% mutate(pi_us = yoy_log(CPIAUCSL)) %>%
  filter(!is.na(pi_us))

# ---- JP inflation rate ----
jp_path = '../data/cpi_jp_self_sourced.csv'
jp_raw = read_csv(jp_path, show_col_types = FALSE)
jp_raw = jp_raw %>% filter(date >= '1974-01-01')
jp = jp_raw %>% mutate(pi_jp = yoy_log(cpijp)) %>%
  filter(!is.na(pi_jp))
```

#### Output Gap (one-sided HP) from Industrial Production
```{r}
library(KFAS)

# ---- helper function ----
one_sided_hp_gap <- function(x, lambda = 14400, log_transform = TRUE){
  v <- as.numeric(x); if (log_transform){ v[v<=0] <- NA; v <- log(v) }
  kf <- KFS(SSModel(v ~ SSMtrend(2, Q=list(0, 1/lambda)), H=1),
            filtering="state", smoothing="none")
  trend <- as.numeric(kf$a[-1,1]); 100 * (v - trend)
}

# ---- US IP Gap ----
us_ip_path = '../data/indpro_us_fred_md_raw.csv'
us_ip_raw = read_csv(us_ip_path, show_col_types = FALSE)
us_ip_raw = us_ip_raw %>% 
  distinct(date, .keep_all = TRUE) %>%
  filter(date >= '1974-01-01')

us_gap <- us_ip_raw %>%
  mutate(gap_us = one_sided_hp_gap(INDPRO, 14400)) %>%
  select(date, gap_us)

# ---- helper function to reconstruct the level data ----
reconstruct_from_dlog <- function(dlog, base = 100) {
  idx <- which(!is.na(dlog)); stopifnot(length(idx) > 0)
  lvl <- rep(NA_real_, length(dlog))
  lvl[idx] <- exp(log(base) + cumsum(replace(dlog[idx], is.na(dlog[idx]), 0)))
  lvl
}

# ---- JP IP Gap ----
jp_ip_path = '../data/iip_jp.csv'
jp_ip_raw = read_csv(jp_ip_path, show_col_types = FALSE)
jp_ip_raw = jp_ip_raw %>% filter (date >= '1974-01-01')
jp_gap <- jp_ip_raw %>%
  mutate(
    iip_level = reconstruct_from_dlog(iipjp, base = 1),
    gap_jp    = one_sided_hp_gap(iip_level, lambda = 14400) * 0.01
  ) %>%
  transmute(date, gap_jp)

```

#### policy/short rates
```{r}
# ---- US rate ----
us_rate_path = '../data/fedfund_us.csv'
us_rate_raw = read_csv(us_rate_path, show_col_types = FALSE) %>%
  filter(date >= "1974-01-01") %>% 
  mutate(i_us_l1 = FEDFUNDS) %>% select (date, i_us_l1)

# ---- JP rate ----
jp_rate_path = '../data/rate_jp.csv'
jp_rate_raw = read_csv(jp_rate_path, show_col_types = FALSE) %>% 
  filter (date >= '1974-01-01') %>%
  mutate (i_jp_l1 = rate) %>%
  select (date, i_jp_l1)
```

#### FX return target

```{r}
# ---- join regressors to returns
regs <- us %>% select(date, pi_us) %>%
  inner_join(jp %>% select(date, pi_jp), by = "date") %>%
  inner_join(us_gap %>% select(date, gap_us), by = "date") %>%
  inner_join(jp_gap %>% select(date, gap_jp), by = "date") %>%
  inner_join(us_rate_raw %>% select(date, i_us_l1), by = "date") %>%
  inner_join(jp_rate_raw %>% select(date, i_jp_l1), by = "date")
```

```{r}
fx <- read_csv("../data/df_1m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_1m) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_1m))

base <- fx %>%
  mutate(date = as.Date(date)) %>%
  inner_join(regs, by = "date") %>%
  arrange(date) %>%
  filter(date <= as.Date("2022-12-31"))

# ---- rolling OLS with fixed window determined at cutoff

roll_ols_multi <- function(dat_h, h, cutoff_date){
  dat_h <- dat_h %>% 
    tidyr::drop_na(Y_log_return_1m, pi_us, pi_jp, gap_us, gap_jp, i_us_l1, i_jp_l1)

  # window size = usable rows up to cutoff (labels known up to cutoff)
  W <- dat_h %>% filter(date <= cutoff_date) %>% nrow()

  # first decision date index (D = cutoff + h months)
  D0 <- cutoff_date %m+% months(h)
  i_start <- which(dat_h$date == D0)
  if (length(i_start) == 0) stop("First decision date not found in data.")

  n <- nrow(dat_h)
  yhat_tr  <- rep(NA_real_, n)
  yhat_rw0 <- rep(0, n)

  for (i in i_start:n){
    tr_end   <- i - h
    tr_start <- tr_end - W + 1
    if (tr_start < 1) next

    fit <- lm(Y_log_return_1m ~ pi_us + pi_jp + gap_us + gap_jp + i_us_l1 + i_jp_l1,
              data = dat_h[tr_start:tr_end, ])

    yhat_tr[i] <- predict(fit, newdata = dat_h[i, , drop = FALSE])
  }

  oos <- dat_h %>%
    mutate(f_tr = yhat_tr, f_rw0 = yhat_rw0) %>%
    filter(!is.na(f_tr))

  rmse <- function(y, yhat) sqrt(mean((y - yhat)^2, na.rm = TRUE))
  e_tr  <- oos$Y_log_return_1m - oos$f_tr
  e_rw0 <- oos$Y_log_return_1m - oos$f_rw0

  summary <- tibble::tibble(
    h = h,
    window_W = W,
    first_decision_date = dat_h$date[i_start],
    n_oos = nrow(oos),
    RMSE_TR   = rmse(oos$Y_log_return_1m, oos$f_tr),   # <- was oos$target
    RMSE_RW0  = rmse(oos$Y_log_return_1m, oos$f_rw0),  # <- was oos$target
    R2_OOS_vs_RW0 = 1 - sum(e_tr^2) / sum(e_rw0^2)
  )

  list(summary = summary, oos = oos)
}

# ---- fit and run
h <- 1
cutoff <- as.Date("2012-12-01")

out <- roll_ols_multi(base, h, cutoff)
summary_tbl <- out$summary
oos_1m      <- out$oos

print(summary_tbl)
# head(oos_1m)
```


```{r}
fx <- read_csv("../data/df_3m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_3m) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_3m))

base <- fx %>%
  mutate(date = as.Date(date)) %>%
  inner_join(regs, by = "date") %>%
  arrange(date) %>%
  filter(date <= as.Date("2022-12-31"))

# ---- rolling OLS with fixed window determined at cutoff

roll_ols_multi <- function(dat_h, h, cutoff_date){
  dat_h <- dat_h %>% 
    tidyr::drop_na(Y_log_return_3m, pi_us, pi_jp, gap_us, gap_jp, i_us_l1, i_jp_l1)

  # window size = usable rows up to cutoff (labels known up to cutoff)
  W <- dat_h %>% filter(date <= cutoff_date) %>% nrow()

  # first decision date index (D = cutoff + h months)
  D0 <- cutoff_date %m+% months(h)
  i_start <- which(dat_h$date == D0)
  if (length(i_start) == 0) stop("First decision date not found in data.")

  n <- nrow(dat_h)
  yhat_tr  <- rep(NA_real_, n)
  yhat_rw0 <- rep(0, n)

  for (i in i_start:n){
    tr_end   <- i - h
    tr_start <- tr_end - W + 1
    if (tr_start < 1) next

    fit <- lm(Y_log_return_3m ~ pi_us + pi_jp + gap_us + gap_jp + i_us_l1 + i_jp_l1,
              data = dat_h[tr_start:tr_end, ])

    yhat_tr[i] <- predict(fit, newdata = dat_h[i, , drop = FALSE])
  }

  oos <- dat_h %>%
    mutate(f_tr = yhat_tr, f_rw0 = yhat_rw0) %>%
    filter(!is.na(f_tr))

  rmse <- function(y, yhat) sqrt(mean((y - yhat)^2, na.rm = TRUE))
  e_tr  <- oos$Y_log_return_3m - oos$f_tr
  e_rw0 <- oos$Y_log_return_3m - oos$f_rw0

  summary <- tibble::tibble(
    h = h,
    window_W = W,
    first_decision_date = dat_h$date[i_start],
    n_oos = nrow(oos),
    RMSE_TR   = rmse(oos$Y_log_return_3m, oos$f_tr),   # <- was oos$target
    RMSE_RW0  = rmse(oos$Y_log_return_3m, oos$f_rw0),  # <- was oos$target
    R2_OOS_vs_RW0 = 1 - sum(e_tr^2) / sum(e_rw0^2)
  )

  list(summary = summary, oos = oos)
}

# ---- fit and run
h <- 3
cutoff <- as.Date("2012-12-01")

out <- roll_ols_multi(base, h, cutoff)
summary_tbl <- out$summary
oos_3m      <- out$oos

print(summary_tbl)
# head(oos_3m)
```

```{r}
fx <- read_csv("../data/df_6m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_6m) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_6m))

base <- fx %>%
  mutate(date = as.Date(date)) %>%
  inner_join(regs, by = "date") %>%
  arrange(date) %>%
  filter(date <= as.Date("2022-12-31"))

# ---- rolling OLS with fixed window determined at cutoff

roll_ols_multi <- function(dat_h, h, cutoff_date){
  dat_h <- dat_h %>% 
    tidyr::drop_na(Y_log_return_6m, pi_us, pi_jp, gap_us, gap_jp, i_us_l1, i_jp_l1)

  # window size = usable rows up to cutoff (labels known up to cutoff)
  W <- dat_h %>% filter(date <= cutoff_date) %>% nrow()

  # first decision date index (D = cutoff + h months)
  D0 <- cutoff_date %m+% months(h)
  i_start <- which(dat_h$date == D0)
  if (length(i_start) == 0) stop("First decision date not found in data.")

  n <- nrow(dat_h)
  yhat_tr  <- rep(NA_real_, n)
  yhat_rw0 <- rep(0, n)

  for (i in i_start:n){
    tr_end   <- i - h
    tr_start <- tr_end - W + 1
    if (tr_start < 1) next

    fit <- lm(Y_log_return_6m ~ pi_us + pi_jp + gap_us + gap_jp + i_us_l1 + i_jp_l1,
              data = dat_h[tr_start:tr_end, ])

    yhat_tr[i] <- predict(fit, newdata = dat_h[i, , drop = FALSE])
  }

  oos <- dat_h %>%
    mutate(f_tr = yhat_tr, f_rw0 = yhat_rw0) %>%
    filter(!is.na(f_tr))

  rmse <- function(y, yhat) sqrt(mean((y - yhat)^2, na.rm = TRUE))
  e_tr  <- oos$Y_log_return_6m - oos$f_tr
  e_rw0 <- oos$Y_log_return_6m - oos$f_rw0

  summary <- tibble::tibble(
    h = h,
    window_W = W,
    first_decision_date = dat_h$date[i_start],
    n_oos = nrow(oos),
    RMSE_TR   = rmse(oos$Y_log_return_6m, oos$f_tr),   # <- was oos$target
    RMSE_RW0  = rmse(oos$Y_log_return_6m, oos$f_rw0),  # <- was oos$target
    R2_OOS_vs_RW0 = 1 - sum(e_tr^2) / sum(e_rw0^2)
  )

  list(summary = summary, oos = oos)
}

# ---- fit and run
h <- 6
cutoff <- as.Date("2012-12-01")

out <- roll_ols_multi(base, h, cutoff)
summary_tbl <- out$summary
oos_6m      <- out$oos

print(summary_tbl)
# head(oos_6m)
```

```{r}
fx <- read_csv("../data/df_12m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_12m) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_12m))

base <- fx %>%
  mutate(date = as.Date(date)) %>%
  inner_join(regs, by = "date") %>%
  arrange(date) %>%
  filter(date <= as.Date("2022-12-31"))

# ---- rolling OLS with fixed window determined at cutoff

roll_ols_multi <- function(dat_h, h, cutoff_date){
  dat_h <- dat_h %>% 
    tidyr::drop_na(Y_log_return_12m, pi_us, pi_jp, gap_us, gap_jp, i_us_l1, i_jp_l1)

  # window size = usable rows up to cutoff (labels known up to cutoff)
  W <- dat_h %>% filter(date <= cutoff_date) %>% nrow()

  # first decision date index (D = cutoff + h months)
  D0 <- cutoff_date %m+% months(h)
  i_start <- which(dat_h$date == D0)
  if (length(i_start) == 0) stop("First decision date not found in data.")

  n <- nrow(dat_h)
  yhat_tr  <- rep(NA_real_, n)
  yhat_rw0 <- rep(0, n)

  for (i in i_start:n){
    tr_end   <- i - h
    tr_start <- tr_end - W + 1
    if (tr_start < 1) next

    fit <- lm(Y_log_return_12m ~ pi_us + pi_jp + gap_us + gap_jp + i_us_l1 + i_jp_l1,
              data = dat_h[tr_start:tr_end, ])

    yhat_tr[i] <- predict(fit, newdata = dat_h[i, , drop = FALSE])
  }

  oos <- dat_h %>%
    mutate(f_tr = yhat_tr, f_rw0 = yhat_rw0) %>%
    filter(!is.na(f_tr))

  rmse <- function(y, yhat) sqrt(mean((y - yhat)^2, na.rm = TRUE))
  e_tr  <- oos$Y_log_return_12m - oos$f_tr
  e_rw0 <- oos$Y_log_return_12m - oos$f_rw0

  summary <- tibble::tibble(
    h = h,
    window_W = W,
    first_decision_date = dat_h$date[i_start],
    n_oos = nrow(oos),
    RMSE_TR   = rmse(oos$Y_log_return_12m, oos$f_tr),   # <- was oos$target
    RMSE_RW0  = rmse(oos$Y_log_return_12m, oos$f_rw0),  # <- was oos$target
    R2_OOS_vs_RW0 = 1 - sum(e_tr^2) / sum(e_rw0^2)
  )

  list(summary = summary, oos = oos)
}

# ---- fit and run
h <- 12
cutoff <- as.Date("2012-12-01")

out <- roll_ols_multi(base, h, cutoff)
summary_tbl <- out$summary
oos_12m      <- out$oos

print(summary_tbl)
# head(oos_12m)
```


















