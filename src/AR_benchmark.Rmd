---
title: "AR benchmark"
author: "Erica"
date: "2025-11-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Preperation
```{r}
library(readr)
library(dplyr)
```

### Choose AR(p)
```{r}
# ---- choose AR(p) ----
Lmax <- floor(12 * (Tn/100)^(1/4))
# Fit AR(p) for p = 0..Lmax; compute BIC = AIC with k = log(T)
r1m <- df_1m %>% pull(Y_log_return_1m)
bic_tbl <- lapply(0:Lmax, function(p) {
  fit <- arima(r1m, order = c(p, 0, 0), include.mean = TRUE, method = "ML")
  data.frame(p = p,
             BIC = AIC(fit, k = log(Tn)),
             sigma2 = fit$sigma2)
}) %>% bind_rows()
p_star <- bic_tbl$p[which.min(bic_tbl$BIC)]
# p = 1
```


### Forecast Horizon = 1m
```{r}
# ---- read dataset ----
df_1m <- read_csv("../data/df_1m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_1m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_1m), !is.na(monthly_return_lag1))
h <- 1

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_1m %>%
  filter (date <= cutoff, !is.na(Y_log_return_1m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_1m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_1m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_1m ~ monthly_return_lag1,
            data = df_1m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_1m[i, , drop = FALSE])
  
  mu_h <- mean(df_1m[tr_start:tr_end, "Y_log_return_1m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_1m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_1m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_1m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_1m - oos$yhat_rw_drift


# ---- directional accuracy (exclude zeros by default) ----
da <- function(y, yhat, drop_zero = TRUE) {
  sy <- sign(y); sf <- sign(yhat)
  ok <- is.finite(sy) & is.finite(sf)
  if (drop_zero) ok <- ok & sy != 0 & sf != 0
  mean(sy[ok] == sf[ok])
}

DA_AR1      <- da(oos$Y_log_return_1m, oos$yhat_ar1, drop_zero = TRUE)
DA_RW0      <- da(oos$Y_log_return_1m, oos$yhat_rw0, drop_zero = TRUE)
DA_RW_DRIFT <- da(oos$Y_log_return_1m, oos$yhat_rw_drift, drop_zero = TRUE)

# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon            = paste0(h, "m"),
  window_W           = W,
  first_decision_date= df_1m$date[i_start],
  n_oos              = nrow(oos),
  RMSE_AR1           = rmse(e_ar1),
  RMSE_RW0           = rmse(e_rw0),
  RMSE_RW_DRIFT      = rmse(e_rw_dr),
  R2_OOS             = 1 - sum(e_ar1^2) / sum(e_rw0^2),
  DA_AR1             = DA_AR1,
  DA_RW0             = DA_RW0,
  DA_RW_DRIFT        = DA_RW_DRIFT
)

print(summary_tbl)

oostbl = oos %>% select (date, Y_log_return_1m, yhat_ar1) %>%
  mutate (error = Y_log_return_1m - yhat_ar1)

write.csv(oostbl, "../data/ar1_err_tbl1.csv", row.names = FALSE)

```

## Forecast Horizon = 3m
```{r}
# ---- read dataset ----
df_3m <- read_csv("../data/df_3m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_3m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_3m), !is.na(monthly_return_lag1))
h <- 3

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_3m %>%
  filter (date <= cutoff, !is.na(Y_log_return_3m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_3m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_3m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_3m ~ monthly_return_lag1,
            data = df_3m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_3m[i, , drop = FALSE])
  
  mu_h <- mean(df_3m[tr_start:tr_end, "Y_log_return_3m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_3m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_3m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_3m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_3m - oos$yhat_rw_drift


# ---- directional accuracy (exclude zeros by default) ----
da <- function(y, yhat, drop_zero = TRUE) {
  sy <- sign(y); sf <- sign(yhat)
  ok <- is.finite(sy) & is.finite(sf)
  if (drop_zero) ok <- ok & sy != 0 & sf != 0
  mean(sy[ok] == sf[ok])
}

DA_AR1      <- da(oos$Y_log_return_3m, oos$yhat_ar1, drop_zero = TRUE)
DA_RW0      <- da(oos$Y_log_return_3m, oos$yhat_rw0, drop_zero = TRUE)
DA_RW_DRIFT <- da(oos$Y_log_return_3m, oos$yhat_rw_drift, drop_zero = TRUE)

# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon            = paste0(h, "m"),
  window_W           = W,
  first_decision_date= df_3m$date[i_start],
  n_oos              = nrow(oos),
  RMSE_AR1           = rmse(e_ar1),
  RMSE_RW0           = rmse(e_rw0),
  RMSE_RW_DRIFT      = rmse(e_rw_dr),
  R2_OOS             = 1 - sum(e_ar1^2) / sum(e_rw0^2),
  DA_AR1             = DA_AR1,
  DA_RW0             = DA_RW0,
  DA_RW_DRIFT        = DA_RW_DRIFT
)

print(summary_tbl)
```

### Forecast Horizon = 6m
```{r}
# ---- read dataset ----
df_6m <- read_csv("../data/df_6m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_6m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_6m), !is.na(monthly_return_lag1))
h <- 6

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_6m %>%
  filter (date <= cutoff, !is.na(Y_log_return_6m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_6m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_6m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_6m ~ monthly_return_lag1,
            data = df_6m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_6m[i, , drop = FALSE])
  
  mu_h <- mean(df_6m[tr_start:tr_end, "Y_log_return_6m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_6m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_6m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_6m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_6m - oos$yhat_rw_drift


# ---- directional accuracy (exclude zeros by default) ----
da <- function(y, yhat, drop_zero = TRUE) {
  sy <- sign(y); sf <- sign(yhat)
  ok <- is.finite(sy) & is.finite(sf)
  if (drop_zero) ok <- ok & sy != 0 & sf != 0
  mean(sy[ok] == sf[ok])
}

DA_AR1      <- da(oos$Y_log_return_6m, oos$yhat_ar1, drop_zero = TRUE)
DA_RW0      <- da(oos$Y_log_return_6m, oos$yhat_rw0, drop_zero = TRUE)
DA_RW_DRIFT <- da(oos$Y_log_return_6m, oos$yhat_rw_drift, drop_zero = TRUE)

# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon            = paste0(h, "m"),
  window_W           = W,
  first_decision_date= df_6m$date[i_start],
  n_oos              = nrow(oos),
  RMSE_AR1           = rmse(e_ar1),
  RMSE_RW0           = rmse(e_rw0),
  RMSE_RW_DRIFT      = rmse(e_rw_dr),
  R2_OOS             = 1 - sum(e_ar1^2) / sum(e_rw0^2),
  DA_AR1             = DA_AR1,
  DA_RW0             = DA_RW0,
  DA_RW_DRIFT        = DA_RW_DRIFT
)

print(summary_tbl)
```

### Forecast Horizon = 12m
```{r}
# ---- read dataset ----
df_12m <- read_csv("../data/df_12m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_12m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_12m), !is.na(monthly_return_lag1))
h <- 12

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_12m %>%
  filter (date <= cutoff, !is.na(Y_log_return_12m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_12m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_12m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_12m ~ monthly_return_lag1,
            data = df_12m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_12m[i, , drop = FALSE])
  
  mu_h <- mean(df_12m[tr_start:tr_end, "Y_log_return_12m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_12m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_12m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_12m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_12m - oos$yhat_rw_drift


# ---- directional accuracy (exclude zeros by default) ----
da <- function(y, yhat, drop_zero = TRUE) {
  sy <- sign(y); sf <- sign(yhat)
  ok <- is.finite(sy) & is.finite(sf)
  if (drop_zero) ok <- ok & sy != 0 & sf != 0
  mean(sy[ok] == sf[ok])
}

DA_AR1      <- da(oos$Y_log_return_12m, oos$yhat_ar1, drop_zero = TRUE)
DA_RW0      <- da(oos$Y_log_return_12m, oos$yhat_rw0, drop_zero = TRUE)
DA_RW_DRIFT <- da(oos$Y_log_return_12m, oos$yhat_rw_drift, drop_zero = TRUE)

# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon            = paste0(h, "m"),
  window_W           = W,
  first_decision_date= df_6m$date[i_start],
  n_oos              = nrow(oos),
  RMSE_AR1           = rmse(e_ar1),
  RMSE_RW0           = rmse(e_rw0),
  RMSE_RW_DRIFT      = rmse(e_rw_dr),
  R2_OOS             = 1 - sum(e_ar1^2) / sum(e_rw0^2),
  DA_AR1             = DA_AR1,
  DA_RW0             = DA_RW0,
  DA_RW_DRIFT        = DA_RW_DRIFT
)

print(summary_tbl)
```

```{r}
# ---------- helper: fixed-split OLS (no rolling) ----------
fixed_split_ols <- function(dat, target_col, cutoff_date) {
  dat <- dat %>%
    mutate(date = as.Date(date)) %>%
    arrange(date)

  # predictors = all except date + target
  pred_cols <- setdiff(names(dat), c("date", target_col))
  # keep numeric predictors only (avoid factors/char)
  pred_cols <- pred_cols[sapply(dat[pred_cols], is.numeric)]

  # drop NAs in target/predictors
  dat <- dat %>% drop_na(all_of(c(target_col, pred_cols)))

  # train â‰¤ cutoff; test > cutoff (labels already aligned via your lead() build)
  train <- dat %>% filter(date <= cutoff_date)
  test  <- dat %>% filter(date  > cutoff_date)

  if (nrow(train) < 10L) stop("Too few train rows.")
  if (nrow(test)  <  1L) stop("No test rows after cutoff.")

  # safe formula (handles weird names)
  fml <- reformulate(termlabels = pred_cols, response = target_col)

  fit <- lm(fml, data = train)

  test <- test %>%
    mutate(
      f_ols = as.numeric(predict(fit, newdata = cur_data())),
      f_rw0 = 0
    ) %>%
    drop_na(f_ols)

  y   <- test[[target_col]]
  e_m <- y - test$f_ols
  e_rw<- y - test$f_rw0

  rmse <- function(z) sqrt(mean(z^2, na.rm = TRUE))

  # Directional Accuracy (exclude zeros by default)
  da <- function(y, yhat, drop_zero = TRUE) {
    sy <- sign(y); sf <- sign(yhat)
    ok <- is.finite(sy) & is.finite(sf)
    if (drop_zero) ok <- ok & sy != 0 & sf != 0
    if (!any(ok)) return(NA_real_)
    mean(sy[ok] == sf[ok])
  }

  summary <- tibble::tibble(
    cutoff_date        = cutoff_date,
    n_train            = nrow(train),
    n_test             = nrow(test),
    test_start         = min(test$date),
    test_end           = max(test$date),
    RMSE_OLS           = rmse(e_m),
    RMSE_RW0           = rmse(e_rw),
    R2_OOS_vs_RW0      = 1 - sum(e_m^2) / sum(e_rw^2),
    DA_OLS             = da(y, test$f_ols, drop_zero = TRUE),
    DA_RW0             = da(y, test$f_rw0, drop_zero = TRUE)
  )

  list(summary = summary, oos = test %>% select(date, !!target_col, f_ols, f_rw0))
}

# ---------- load each horizon dataset, run once per h ----------
cutoff <- as.Date("2012-12-01")

# 1m
base_1m <- read_csv("../data/df_1m_lag.csv", show_col_types = FALSE) %>% select (-current_fx_level, -fx_level_fwd_1m)
res_1m  <- fixed_split_ols(base_1m, target_col = "Y_log_return_1m", cutoff_date = cutoff)

# 3m
base_3m <- read_csv("../data/df_3m_lag.csv", show_col_types = FALSE) %>% select (-current_fx_level, -fx_level_fwd_3m)
res_3m  <- fixed_split_ols(base_3m, target_col = "Y_log_return_3m", cutoff_date = cutoff)

# 6m
base_6m <- read_csv("../data/df_6m_lag.csv", show_col_types = FALSE) %>% select (-current_fx_level, -fx_level_fwd_6m)
res_6m  <- fixed_split_ols(base_6m, target_col = "Y_log_return_6m", cutoff_date = cutoff)

# 12m
base_12m <- read_csv("../data/df_12m_lag.csv", show_col_types = FALSE) %>% select (-current_fx_level, -fx_level_fwd_12m)
res_12m  <- fixed_split_ols(base_12m, target_col = "Y_log_return_12m", cutoff_date = cutoff)

# ---------- combined summary ----------
summary_tbl <- bind_rows(
  res_1m$summary %>% mutate(horizon = "1m"),
  res_3m$summary %>% mutate(horizon = "3m"),
  res_6m$summary %>% mutate(horizon = "6m"),
  res_12m$summary %>% mutate(horizon = "12m")
) %>%
  select(horizon, everything())

print(summary_tbl)

# Per-horizon OOS predictions available as:
# res_1m$oos ; res_3m$oos ; res_6m$oos ; res_12m$oos

```


### train/test split
```{r}
fixed_split_ar1 <- function(dat, target_col, lag1_col, h, cutoff_date) {
  dat <- dat %>%
    select(date, !!rlang::sym(target_col), !!rlang::sym(lag1_col)) %>%
    arrange(date) %>%
    tidyr::drop_na()

  train_end <- cutoff_date %m-% months(h)
  train <- dat %>% filter(date <= train_end)
  test  <- dat %>% filter(date  >  cutoff_date)
  stopifnot(nrow(train) >= 12, nrow(test) >= 1)

  fit <- lm(reformulate(lag1_col, target_col), data = train)

  # forecasts for all test dates (single fit)
  f_ar1       <- as.numeric(predict(fit, newdata = test))
  f_rw0       <- rep(0, nrow(test))
  mu_train    <- mean(train[[target_col]], na.rm = TRUE)
  f_rw_drift  <- rep(mu_train, nrow(test))

  oos <- test %>% mutate(yhat_ar1 = f_ar1, yhat_rw0 = f_rw0, yhat_rw_drift = f_rw_drift)

  rmse <- function(e) sqrt(mean(e^2))
  e_ar1 <- oos[[target_col]] - oos$yhat_ar1
  e_rw0 <- oos[[target_col]] - oos$yhat_rw0
  e_dr  <- oos[[target_col]] - oos$yhat_rw_drift

  da <- function(y, yhat, drop_zero = TRUE){
    sy <- sign(y); sf <- sign(yhat)
    ok <- is.finite(sy) & is.finite(sf)
    if (drop_zero) ok <- ok & sy != 0 & sf != 0
    if (!any(ok)) return(NA_real_)
    mean(sy[ok] == sf[ok])
  }

  summary <- tibble(
    horizon             = paste0(h, "m"),
    train_end           = train_end,
    cutoff_date         = cutoff_date,
    n_train             = nrow(train),
    n_oos               = nrow(oos),
    RMSE_AR1            = rmse(e_ar1),
    RMSE_RW0            = rmse(e_rw0),
    RMSE_RW_DRIFT       = rmse(e_dr),
    R2_OOS_vs_RW0       = 1 - sum(e_ar1^2) / sum(e_rw0^2),
    DA_AR1              = da(oos[[target_col]], oos$yhat_ar1),
    DA_RW0              = da(oos[[target_col]], oos$yhat_rw0),
    DA_RW_DRIFT         = da(oos[[target_col]], oos$yhat_rw_drift)
  )

  list(summary = summary, oos = oos)
}
```

```{r}
cutoff <- as.Date("2012-12-01")

# 1m
d1 <- read_csv("../data/df_1m_lag.csv", show_col_types = FALSE) %>% mutate(date = as.Date(date))
out_1m <- fixed_split_ar1(d1, target_col = "Y_log_return_1m",  lag1_col = "monthly_return_lag1", h = 1,  cutoff_date = cutoff)

# 3m
d3 <- read_csv("../data/df_3m_lag.csv", show_col_types = FALSE) %>% mutate(date = as.Date(date))
out_3m <- fixed_split_ar1(d3, target_col = "Y_log_return_3m",  lag1_col = "monthly_return_lag1", h = 3,  cutoff_date = cutoff)

# 6m
d6 <- read_csv("../data/df_6m_lag.csv", show_col_types = FALSE) %>% mutate(date = as.Date(date))
out_6m <- fixed_split_ar1(d6, target_col = "Y_log_return_6m",  lag1_col = "monthly_return_lag1", h = 6,  cutoff_date = cutoff)

# 12m
d12 <- read_csv("../data/df_12m_lag.csv", show_col_types = FALSE) %>% mutate(date = as.Date(date))
out_12m <- fixed_split_ar1(d12, target_col = "Y_log_return_12m", lag1_col = "monthly_return_lag1", h = 12, cutoff_date = cutoff)

# Combine summaries
bind_rows(
  out_1m$summary,
  out_3m$summary,
  out_6m$summary,
  out_12m$summary
) %>% print()

```















