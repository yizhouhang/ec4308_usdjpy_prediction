---
title: "AR benchmark"
author: "Erica"
date: "2025-11-08"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### Preperation
```{r}
library(readr)
library(dplyr)
```

### Choose AR(p)
```{r}
# ---- choose AR(p) ----
Lmax <- floor(12 * (Tn/100)^(1/4))
# Fit AR(p) for p = 0..Lmax; compute BIC = AIC with k = log(T)
r1m <- df_1m %>% pull(Y_log_return_1m)
bic_tbl <- lapply(0:Lmax, function(p) {
  fit <- arima(r1m, order = c(p, 0, 0), include.mean = TRUE, method = "ML")
  data.frame(p = p,
             BIC = AIC(fit, k = log(Tn)),
             sigma2 = fit$sigma2)
}) %>% bind_rows()
p_star <- bic_tbl$p[which.min(bic_tbl$BIC)]
# p = 1
```


### Forecast Horizon = 1m
```{r}
# ---- read dataset ----
df_1m <- read_csv("../data/df_1m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_1m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_1m), !is.na(monthly_return_lag1))
h <- 1

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_1m %>%
  filter (date <= cutoff, !is.na(Y_log_return_1m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_1m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_1m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_1m ~ monthly_return_lag1,
            data = df_1m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_1m[i, , drop = FALSE])
  
  mu_h <- mean(df_1m[tr_start:tr_end, "Y_log_return_1m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_1m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_1m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_1m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_1m - oos$yhat_rw_drift


# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon    = paste0(h, 'm'),
  window_W = W,
  first_decision_date = df_1m$date[i_start],
  n_oos      = nrow(oos),
  RMSE_AR1   = rmse(e_ar1),
  RMSE_RW0   = rmse(e_rw0),
  RMSE_RW_DRIFT = rmse(e_rw_dr),
  R2_OOS     = 1 - sum(e_ar1^2) / sum(e_rw0^2)
)

print(summary_tbl)
#head(oos, 5)
```

## Forecast Horizon = 3m
```{r}
# ---- read dataset ----
df_3m <- read_csv("../data/df_3m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_3m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_3m), !is.na(monthly_return_lag1))
h <- 3

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_3m %>%
  filter (date <= cutoff, !is.na(Y_log_return_3m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_3m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_3m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_3m ~ monthly_return_lag1,
            data = df_3m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_3m[i, , drop = FALSE])
  
  mu_h <- mean(df_3m[tr_start:tr_end, "Y_log_return_3m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_3m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_3m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_3m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_3m - oos$yhat_rw_drift


# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon    = paste0(h, 'm'),
  window_W = W,
  first_decision_date = df_3m$date[i_start],
  n_oos      = nrow(oos),
  RMSE_AR1   = rmse(e_ar1),
  RMSE_RW0   = rmse(e_rw0),
  RMSE_RW_DRIFT = rmse(e_rw_dr),
  R2_OOS     = 1 - sum(e_ar1^2) / sum(e_rw0^2)
)

print(summary_tbl)
#head(oos, 5)
```

### Forecast Horizon = 6m
```{r}
# ---- read dataset ----
df_6m <- read_csv("../data/df_6m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_6m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_6m), !is.na(monthly_return_lag1))
h <- 6

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_6m %>%
  filter (date <= cutoff, !is.na(Y_log_return_6m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_6m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_6m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_6m ~ monthly_return_lag1,
            data = df_6m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_6m[i, , drop = FALSE])
  
  mu_h <- mean(df_6m[tr_start:tr_end, "Y_log_return_6m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_6m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_6m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_6m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_6m - oos$yhat_rw_drift


# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon    = paste0(h, 'm'),
  window_W = W,
  first_decision_date = df_6m$date[i_start],
  n_oos      = nrow(oos),
  RMSE_AR1   = rmse(e_ar1),
  RMSE_RW0   = rmse(e_rw0),
  RMSE_RW_DRIFT = rmse(e_rw_dr),
  R2_OOS     = 1 - sum(e_ar1^2) / sum(e_rw0^2)
)

print(summary_tbl)
#head(oos, 5)
```

### Forecast Horizon = 12m
```{r}
# ---- read dataset ----
df_12m <- read_csv("../data/df_12m_lag.csv", show_col_types = FALSE) %>%
  select(date, Y_log_return_12m, monthly_return_lag1) %>%
  arrange(date) %>%
  filter(!is.na(Y_log_return_12m), !is.na(monthly_return_lag1))
h <- 12

# ---- rolling window size ----
cutoff <- as.Date ('2012-12-01')
W <- df_12m %>%
  filter (date <= cutoff, !is.na(Y_log_return_12m),!is.na(monthly_return_lag1)) %>%
  nrow()
idx_cut <- which(df_12m$date == cutoff)
i_start <- idx_cut + h

# ---- fit AR ----
n <- nrow(df_12m)
yhat_ar1 <- rep(NA_real_, n)
yhat_rw0 <- rep(0, n)
yhat_rw_drift <- rep(NA_real_, n) 

for (i in seq_len(n)) {
  tr_end   <- i - h
  tr_start <- tr_end - W + 1
    if (tr_start < 1) next

  fit <- lm(Y_log_return_12m ~ monthly_return_lag1,
            data = df_12m[tr_start:tr_end, ])
  yhat_ar1[i] <- predict(fit, newdata = df_12m[i, , drop = FALSE])
  
  mu_h <- mean(df_12m[tr_start:tr_end, "Y_log_return_12m", drop=TRUE], na.rm = TRUE)
  yhat_rw_drift[i] <- mu_h
}

# ---- calculate rmse ----
oos <- df_12m %>%
  mutate(yhat_ar1 = yhat_ar1,
         yhat_rw0 = yhat_rw0,
         yhat_rw_drift = yhat_rw_drift) %>%
  filter(!is.na(yhat_ar1))

rmse <- function(e) sqrt(mean(e^2))
e_ar1 <- oos$Y_log_return_12m - oos$yhat_ar1
e_rw0 <- oos$Y_log_return_12m - oos$yhat_rw0
e_rw_dr <- oos$Y_log_return_12m - oos$yhat_rw_drift


# ---- output summary ----
summary_tbl <- tibble::tibble(
  horizon    = paste0(h, 'm'),
  window_W = W,
  first_decision_date = df_12m$date[i_start],
  n_oos      = nrow(oos),
  RMSE_AR1   = rmse(e_ar1),
  RMSE_RW0   = rmse(e_rw0),
  RMSE_RW_DRIFT = rmse(e_rw_dr),
  R2_OOS     = 1 - sum(e_ar1^2) / sum(e_rw0^2)
)

print(summary_tbl)
#head(oos, 5)
```









