---
title: "tree"
output: html_document
date: "2025-11-06"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r load packages }
# install.packages("randomForest")
# install.packages("gbm")
library(randomForest)  # bagging & random forest
library(gbm)           # boosting
```

```{r load datasets}
# getwd()
setwd("/Users/judy/Desktop/EC4308/ec4308_usdjpy_prediction/src")

# read datasets (different horizons)
pred1m = read.csv("../data/df_1m_lag.csv")
pred1m = read.csv("../data/df_1m_lag.csv")
pred6m = read.csv("../data/df_6m_lag.csv")
pred12m = read.csv("../data/df_12m_lag.csv")

for (d in c("pred1m", "pred1m", "pred6m", "pred12m")) {
  df <- get(d)                  # retrieve the dataset by name
  df[[1]] <- as.Date(df[[1]])   # convert first column to Date
  df <- df[order(df$date), ]    # sort ascending
  assign(d, df)                 # assign it back to the variable name
}
```
# Rolling window
## 1) Random forest rolling window
```{r}
rolling_rf_rmse <- function(data, data_name, nprev = 120, y_col = 4) {
  
  y_all <- data[[y_col]]
  X_all <- data[, -c(1, 2, 3, y_col), drop = FALSE]
  
  n <- nrow(data)
  stopifnot(n > nprev)
  
  preds <- rep(NA_real_, nprev)
  actual <- y_all[(n - nprev + 1):n]
  importance_list <- vector("list", nprev)
  
  
  #### tune mtry
  # cat("Tuning mtry using the first training window...\n")
  # X_tune <- X_all[1:(n - nprev), , drop = FALSE]
  # y_tune <- y_all[1:(n - nprev)]
  # 
  # pdf(NULL)  # prevent any plotting device issues
  # tune_res <- tuneRF(
  #   x = X_tune, y = y_tune,
  #   mtryStart = floor(sqrt(ncol(X_tune))),
  #   stepFactor = 2,
  #   improve = 0.05,
  #   nodesize = 5,
  #   ntreeTry = 5000,
  #   doBest = TRUE,
  #   trace = FALSE,
  #   plot = FALSE
  # )
  # dev.off()
  # 
  # if (is.data.frame(tune_res) || is.matrix(tune_res)) {
  #   best_mtry <- tune_res[which.min(tune_res[, 2]), 1]
  # } else if (is.numeric(tune_res)) {
  #   best_mtry <- tune_res[1]
  # } else if (is.list(tune_res) && "bestmtry" %in% names(tune_res)) {
  #   best_mtry <- tune_res$bestmtry
  # } else {
  #   best_mtry <- floor(sqrt(ncol(X_tune)))
  #   cat("tuneRF returned unexpected structure — using default mtry =", best_mtry, "\n")
  # }
  # cat("Best mtry selected:", best_mtry, "\n\n")
  # 
  # 
  # cat("Rolling forecasts for", data_name, "started... total =", nprev, "steps\n")

  for (i in nprev:1) {
    # define rolling window
    start_idx <- 1 + nprev - i
    end_idx   <- n - i
    
    X_train <- X_all[start_idx:end_idx, , drop = FALSE]
    y_train <- y_all[start_idx:end_idx]
    X_pred  <- X_all[end_idx + 1, , drop = FALSE]
    
    # fit rf
    rf <- randomForest(x = X_train, y = y_train, 
                       # mtry = best_mtry, 
                       importance = TRUE)
    
    # forecast next obs
    preds[(1 + nprev - i)] <- predict(rf, X_pred)
    importance_list[[i]] <- importance(rf)
    
    if (i %% 10 == 0 || i == 1) {
      cat("Iteration", (1 + nprev - i), "of", nprev, "done\n")
    }
  }
  
  # evaluation
  rmse <- sqrt(mean((actual - preds)^2))
  mae  <- mean(abs(actual - preds))
  da <- ifelse((preds > 0 & actual > 0) | (preds < 0 & actual < 0), 1, 0)
  mean_da <- mean(da)
  cat("Rolling RMSE:", round(rmse, 6), "| MAE:", round(mae, 6), "| DA:", mean_da, "\n")

  # combine results
  results <- data.frame(
    Date = data[(n - nprev + 1):n, 1],
    Actual = actual,
    Forecast = preds
  )
  
  return(list(
    results = results,
    importance_history = importance_list,
    rmse = rmse,
    mae = mae,
    da = mean_da
  ))
}


```

### combine all variable importances
```{r}
# combine all variable importances into one table
aggregate_importance <- function(importance_list) {
  # convert each importance matrix into a data frame with variable names
  imp_dfs <- lapply(importance_list, function(x) {
    df <- as.data.frame(x)
    df$Variable <- rownames(x)
    rownames(df) <- NULL
    df
  })
  
  # stack all data frames together
  imp_all <- do.call(rbind, imp_dfs)
  
  # aggregate by variable name (average across rolling windows)
  imp_summary <- aggregate(. ~ Variable, data = imp_all, FUN = mean, na.rm = TRUE)
  
  # sort by average %IncMSE (most important first)
  imp_summary <- imp_summary[order(-imp_summary$`%IncMSE`), ]
  
  return(imp_summary)
  

}

```

```{r}
# rolling-window forecasts at different horizons
rf_1m_roll <- rolling_rf_rmse(data=pred1m)
rf_1m_roll_importance <- aggregate_importance(rf_1m_roll$importance_history)
rf_1m_roll <- rolling_rf_rmse(data=pred1m)
rf_1m_roll_importance <- aggregate_importance(rf_1m_roll$importance_history)
rf_6m_roll <- rolling_rf_rmse(data=pred6m)
rf_6m_roll_importance <- aggregate_importance(rf_6m_roll$importance_history)
rf_12m_roll <- rolling_rf_rmse(data=pred12m)
rf_12m_roll_importance <- aggregate_importance(rf_12m_roll$importance_history)
```

### Save rf rolling results
```{r}
for (d in c("pred1m", "pred3m", "pred6m", "pred12m")) {
  df <- get(d)
  res <- rolling_rf_rmse(data=df, data_name=d)
  results_list[[d]] <- res
}
save(results_list_rf_roll, file = "/Users/judy/Desktop/EC4308/ec4308_usdjpy_result/rf_rolling_results.RData")

roll_rf_1m <- results_list$pred1m$results
roll_rf_1m$error <- roll_rf_1m$Actual - roll_rf_1m$Forecast
write.csv(roll_rf_1m, file = "/Users/judy/Desktop/rf_err_1m.csv", row.names = FALSE)

roll_rf_6m <- results_list$pred6m$results
roll_rf_6m$error <- roll_rf_6m$Actual - roll_rf_6m$Forecast
write.csv(roll_rf_6m, file = "/Users/judy/Desktop/rf_err_6m.csv", row.names = FALSE)

roll_rf_12m <- results_list$pred12m$results
roll_rf_12m$error <- roll_rf_12m$Actual - roll_rf_12m$Forecast
write.csv(roll_rf_12m, file = "/Users/judy/Desktop/rf_err_12m.csv", row.names = FALSE)

results_list_rf_roll <- list()
#"pred1m", "pred6m", "pred12m"
for (d in c("pred1m", "pred3m", "pred6m", "pred12m")) {
  df <- get(d)
  res <- rolling_rf_rmse(data=df, data_name=d)
  results_list_rf_roll[[d]] <- res
}

save(results_list_rf_roll, file = "/Users/judy/Desktop/EC4308/ec4308_usdjpy_result/rf_tune_rolling_results.RData")

roll_rf_tune_3m <- results_list_rf_roll$pred3m$results
roll_rf_tune_3m$error <- roll_rf_tune_3m$Actual - roll_rf_tune_3m$Forecast
write.csv(roll_rf_tune_3m, file = "/Users/judy/Desktop/rf_tune_err_3m.csv", row.names = FALSE)

# load("/Users/judy/Desktop/EC4308/ec4308_usdjpy_result/rf_tune_rolling_results.RData")

```

### plot
```{r}
plot_backtest <- function(oos, summary_row, target_col, h_label = NULL) {
  stopifnot(all(c("date", "f_tr", "f_rw0") %in% names(oos)))
  if (is.null(h_label)) h_label <- summary_row$h %||% summary_row$horizon %||% "h"

  first_decision <- as.Date(summary_row$first_decision_date)
  rmse_tr  <- signif(summary_row$RMSE_TR %||% summary_row$RMSE_AR1 %||% summary_row$RMSE_PCR, 3)
  rmse_rw0 <- signif(summary_row$RMSE_RW0, 3)
  da_tr    <- signif(summary_row$DA_TR %||% summary_row$DA_AR1 %||% summary_row$DA_PCR, 3)

  df_long <- oos %>%
    transmute(date,
              Actual = .data[[target_col]],
              `Model (TR/OLS)` = f_tr,
              `RW(0)` = f_rw0) %>%
    pivot_longer(-date, names_to = "series", values_to = "value")

  ggplot(df_long, aes(date, value, color = series)) +
    geom_hline(yintercept = 0, linewidth = 0.25, linetype = "dashed", color = "grey50") +
    geom_vline(xintercept = first_decision, linewidth = 0.4, linetype = "dotdash", color = "grey40") +
    geom_line(linewidth = 0.6, na.rm = TRUE) +
    labs(
      title    = paste0("Rolling Backtest (horizon = ", h_label, ")"),
      subtitle = paste0("First decision date: ", first_decision,
                        " | RMSE(Model) = ", rmse_tr,
                        " | RMSE(RW0) = ", rmse_rw0,
                        " | DA(Model) = ", da_tr),
      x = NULL, y = "Log return",
      color = NULL
    ) +
    scale_x_date(labels = label_date_short()) +
    theme_minimal(base_size = 11) +
    theme(legend.position = "top",
          panel.grid.minor = element_blank())
}

# 3-month forecast
rf3m <- results_list_rf_roll$pred3m
summary_rf3m <- list(h = "3m", first_decision_date = rf3m$results$Date[1],
                     RMSE_TR = rf3m$rmse, DA_TR = rf3m$da)
oos_rf3m <- rf3m$results %>%
  rename(date = Date, f_tr = Forecast, f_rw0 = Actual)
plot_backtest(oos_rf3m, summary_rf3m, target_col = "f_rw0", h_label = "3m")
```

## 2) Bagging rolling window
```{r}
# bag <- randomForest(x = X_train, y = y_train, mtry = ncol(X_train), importance = TRUE)
rolling_bag_rmse <- function(data, data_name, nprev = 120, y_col = 4) {
  
  y_all <- data[[y_col]]
  X_all <- data[, -c(1, 2, 3, y_col), drop = FALSE]
  
  n <- nrow(data)
  stopifnot(n > nprev)
  
  preds <- rep(NA_real_, nprev)
  actual <- y_all[(n - nprev + 1):n]
  importance_list <- vector("list", nprev)
  
  cat("Rolling forecasts for", data_name, "started... total =", nprev, "steps\n")

  for (i in nprev:1) {
    # define rolling window
    start_idx <- 1 + nprev - i
    end_idx   <- n - i
    
    X_train <- X_all[start_idx:end_idx, , drop = FALSE]
    y_train <- y_all[start_idx:end_idx]
    X_pred  <- X_all[end_idx + 1, , drop = FALSE]
    
    # fit bagging
    bag <- randomForest(x = X_train, y = y_train, mtry = ncol(X_train), importance = TRUE)
    
    # forecast next obs
    preds[(1 + nprev - i)] <- predict(bag, X_pred)
    importance_list[[i]] <- importance(bag)
    
    if (i %% 10 == 0 || i == 1) {
      cat("Iteration", (1 + nprev - i), "of", nprev, "done\n")
    }
  }
  
  # evaluation
  rmse <- sqrt(mean((actual - preds)^2))
  mae  <- mean(abs(actual - preds))
  da <- ifelse((preds > 0 & actual > 0) | (preds < 0 & actual < 0), 1, 0)
  mean_da <- mean(da)
  cat("Rolling RMSE:", round(rmse, 6), "| MAE:", round(mae, 6), "| DA:", mean_da, "\n")

  # combine results
  results <- data.frame(
    Date = data[(n - nprev + 1):n, 1],
    Actual = actual,
    Forecast = preds
  )
  
  # plot actual vs forecast
  plot(results$Date, results$Actual, type = "l",
       main = paste("Rolling Bagging Forecast vs Actual —", data_name),
       ylab = "Y", xlab = "Date")
  lines(results$Date, results$Forecast, col = "red")
  legend("topleft", legend = c("Actual", "Forecast"),
         col = c("black", "red"), lty = 1)
  
  return(list(
    results = results,
    importance_history = importance_list,
    rmse = rmse,
    mae = mae,
    da = mean_da
  ))
}
```

```{r}
bag_1m_roll <- rolling_bag_rmse(data=pred1m)
bag_1m_roll_importance <- aggregate_importance(bag_1m_roll$importance_history)
bag_1m_roll <- rolling_bag_rmse(data=pred1m)
bag_1m_roll_importance <- aggregate_importance(bag_1m_roll$importance_history)
bag_6m_roll <- rolling_bag_rmse(data=pred6m)
bag_6m_roll_importance <- aggregate_importance(bag_6m_roll$importance_history)
bag_12m_roll <- rolling_bag_rmse(data=pred12m)
bag_12m_roll_importance <- aggregate_importance(bag_12m_roll$importance_history)
```

### Save bag rolling results
```{r}
results_list_bag_roll <- list()

for (d in c("pred1m", "pred1m", "pred6m", "pred12m")) {
  df <- get(d)
  res <- rolling_bag_rmse(data=df, data_name=d)
  results_list_bag_roll[[d]] <- res
}

save(results_list_bag_roll, file = "/Users/judy/Desktop/EC4308/ec4308_usdjpy_result/bag_rolling_results_all.RData")

# load("../model/bag_rolling_results_all.RData")

```

## 3) Boosting rolling window
```{r}
rolling_boost_rmse <- function(data, data_name, nprev = 120, y_col = 4) {
  
  y_all <- data[[y_col]]
  X_all <- data[, -c(1, 2, 3, y_col), drop = FALSE]
  
  n <- nrow(data)
  stopifnot(n > nprev)
  
  preds <- rep(NA_real_, nprev)
  actual <- y_all[(n - nprev + 1):n]
  importance_list <- vector("list", nprev)
  
  cat("Rolling forecasts for", data_name, "started... total =", nprev, "steps\n")
  
  for (i in nprev:1) {
    start_idx <- 1 + nprev - i
    end_idx   <- n - i
    
    X_train <- X_all[start_idx:end_idx, , drop = FALSE]
    y_train <- y_all[start_idx:end_idx]
    X_pred  <- X_all[end_idx + 1, , drop = FALSE]
    
    boost_model <- gbm(
      formula = y_train ~ .,
      data = X_train,
      distribution = "gaussian",   # regression
      n.trees = 300, 
      interaction.depth = 3,       # tree depth
      shrinkage = 0.01,            # learning rate

    )
    

    best_iter <- gbm.perf(boost_model, method = "OOB", plot.it = FALSE)
    

    preds[(1 + nprev - i)] <- predict(boost_model, newdata = X_pred, n.trees = best_iter)
    

    importance_list[[i]] <- summary(boost_model, n.trees = best_iter, plotit = FALSE)
    
    if (i %% 10 == 0 || i == 1) {
      cat("Iteration", (1 + nprev - i), "of", nprev, "done\n")
    }
  }
  

  rmse <- sqrt(mean((actual - preds)^2))
  mae  <- mean(abs(actual - preds))
  da <- ifelse((preds > 0 & actual > 0) | (preds < 0 & actual < 0), 1, 0)
  mean_da <- mean(da)
  cat("Rolling RMSE:", round(rmse, 6),
      "| MAE:", round(mae, 6),
      "| DA:", round(mean_da, 4), "\n")
  

  results <- data.frame(
    Date = data[(n - nprev + 1):n, 1],
    Actual = actual,
    Forecast = preds
  )
  

  plot(results$Date, results$Actual, type = "l",
       main = paste("Rolling Boosting Forecast vs Actual —", data_name),
       ylab = "Y", xlab = "Date")
  lines(results$Date, results$Forecast, col = "red")
  legend("topleft", legend = c("Actual", "Forecast"),
         col = c("black", "red"), lty = 1)
  

  return(list(
    results = results,
    importance_history = importance_list,
    rmse = rmse,
    mae = mae,
    da = mean_da
  ))
}

```


### Save boost rolling results
```{r}
results_list_boost_roll <- list()

for (d in c("pred1m", "pred1m", "pred6m", "pred12m")) { 
  df <- get(d) 
  res <- rolling_boost_rmse(data=df, data_name=d) 
  results_list_boost_roll[[d]] <- res 
  }

save(results_list_boost_roll, file = "/Users/judy/Desktop/EC4308/ec4308_usdjpy_result/boost_rolling_results_all.RData")

# load("/Users/judy/Desktop/EC4308/ec4308_usdjpy_result/boost_rolling_results_all.RData")


roll_boost_6m <- results_list_boost_roll$pred6m$results
roll_boost_6m$error <- roll_boost_6m$Actual - roll_boost_6m$Forecast
write.csv(roll_boost_6m, file = "/Users/judy/Desktop/boost_err_6m.csv", row.names = FALSE)

roll_boost_12m <- results_list_boost_roll$pred12m$results
roll_boost_12m$error <- roll_boost_12m$Actual - roll_boost_12m$Forecast
write.csv(roll_boost_12m, file = "/Users/judy/Desktop/boost_err_12m.csv", row.names = FALSE)

```


# All tree-based models
```{r}
# random forest train/test
load("rf_train_test_results_all.RData")

# random forest rolling window
load("../model/rf_rolling_results_all.RData")

# bagging forest train/
load("bag_train_test_results_all.RData")

# bagging forest rolling window
load("../model/bag_rolling_results_all.RData")
```





